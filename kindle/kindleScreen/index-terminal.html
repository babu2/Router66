<!DOCTYPE html>
<!--<html lang="en" manifest="cache.manifest">-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>KindleScreen</title>
    <meta name="description" content="">
    <meta name="author" content="">
	
    <link rel="stylesheet" type="text/css" href="css/global.css" />
	
	  
	<script src="js/jquery-1.7.1.min.js" type="text/javascript" charset="utf-8"></script>	
	
	<script type="text/javascript">
	
	$(document).ready(function() {
		var lineNumbers = 4;


		String.prototype.visualLength = function() {
			var ruler = $('#ruler');
			ruler.html(String(this));
			//console.log(ruler.width());
			//return ruler.offsetWidth;

			return ruler.width();
		}

/*
		String.prototype.trimToPx = function(length)
		{
		    var tmp = this;
		    var trimmed = this;
		    if (tmp.visualLength() > length)
		    {
		        trimmed += "...";
		        while (trimmed.visualLength() > length)
		        {
		            tmp = tmp.substring(0, tmp.length-1);
		            trimmed = tmp + "...";
		        }
		    }

		    return trimmed;
		}

			var s = "iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii";
			s = "mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm";
			var len = s.visualLength();
			//var stringCut = s.trimToPx(80);

			//console.log(len);
			$('#rulercheck').css("width",len*0.877+"px");
		*/	





		var delay = 100;
		var content = "...";
		var displayedLength = 0;
		var lines = new Array();
		var currentLine = 0;

		prepareLines = function() {
			lines = new Array();
			currentLine = 0;
			
			var words = content.split(" ");
			var line = "";
		 	output = "";
			for (x in words) {
				var containerWidth = $('#text').innerWidth()-130; //2*parseInt($('#text').css("padding"),10)
				var newLine = (line + words[x]);
				if (newLine.visualLength() < containerWidth) line += words[x]+" ";
				else {
					lines.push(line);
					line = words[x]+" ";
				}	
				if (x == words.length-1) lines.push(line);
			}	
			console.log(lines);
			
			for (x in lines) {
				$('#text').html();
			}
			
			
		}


		resetScreen = function() {
			
			$('body').css("background-color","black");
			setTimeout(function () { 
				$('body').css("background-color","white");
		
				var x;
				for (x = 0; x < lineNumbers;x++)	{
					$('#line'+x).html("");	
				}		
			},200);
			
		}
		
		shiftLines = function() {
			
			var x;
			for (x = lineNumbers-1; x > 0;x--)	{
				console.log(x);
				$('#line'+x).html($('#line'+(x-1)).html());	
			}
			$('#line0').html("");
		}
			
		getContent = function() {
			var xmlhttp=new XMLHttpRequest();

			xmlhttp.onreadystatechange=function() {
		  		if (xmlhttp.readyState==4 && xmlhttp.status==200) {
					//console.log("COMPARE: "+content+" ----- "+xmlhttp.responseText);
					if (content != xmlhttp.responseText) {
						content = xmlhttp.responseText;
						//content = "null's Dropbox checks for updates on the interwebz.";
						//$('#text').html(content.substr(0,displayedLength));

						//resetScreen();
						
						shiftLines();
						
  						prepareLines();
                 		writeText();
					}
					else setTimeout("getContent()",200);

		    	}
		  	}


			//xmlhttp.open("GET","helloClient.txt",true);
			xmlhttp.open("GET","textReceiver.php",true);
			xmlhttp.send();
		}
		
		writeText = function() {
			//writing
			if (currentLine< lines.length) { 
				var words = lines[currentLine].split(" ");

				var line = "";
				var x;
				for (x = 0; x < displayedLength; x++) {
					line += words[x]+" ";
				}
				//console.log(line);
				$('#line0').html(line);

				//$('#hidden').html(output.substr(displayedLength+1,content.length));

				//console.log(displayedLength +" --- "+lines[currentLine].length);
				//console.log(currentLine + " " + lines[currentLine]);
				displayedLength++;

				if (displayedLength == words.length) {
					setTimeout(function () { 
						console.log(currentLine+" "+lines.length);
	
						if(currentLine < lines.length-1) shiftLines();
					
						displayedLength = 0;
						currentLine++;
						writeText();
					},950); //450
				}
				else {
					setTimeout(function () { writeText() },300);					
				}
			}		
			else { //reset Screen and request new content
				setTimeout(function () { 
					getContent(); 
				},2000);
			}
		}
		setTimeout("getContent()",0);			
	});
	</script>
	
  </head>

  <body>
 	<div id="screen">
		<div id="text">
				<span id="line3"></span><br />
				<span id="line2"></span><br />
				<span id="line1"></span><br />
				<span id="line0"></span>
		</div>
	</div>
	<div id="rulercheck" style="background-color: black; color: white; width: 540px"> ...</div>
	<span id="ruler"></span><br />	
 </body>
</html>
